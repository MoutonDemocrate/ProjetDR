<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hagimule</a> &gt; <a href="index.source.html" class="el_package">fr.n7.hagimule</a> &gt; <span class="el_source">ServerImpl.java</span></div><h1>ServerImpl.java</h1><pre class="source lang-java linenums">package fr.n7.hagimule;

import org.json.*;
import java.rmi.server.*;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.rmi.*;
import java.sql.*;

import javax.naming.spi.DirStateFactory.Result;

public class ServerImpl extends UnicastRemoteObject implements MuleServer {

    private JSONObject directory;
    private Connection sqlConnection;

<span class="nc" id="L18">    public ServerImpl() throws RemoteException {</span>
<span class="nc" id="L19">        System.out.println(&quot;Searching for directory file...&quot;);</span>
        // Path filePath = Path.of(&quot;directory.json&quot;);
<span class="nc" id="L21">        String content = &quot;&quot;;</span>

        // Chargement du driver SQL
        // Class.forName(&quot;org.sqlite.JDBC&quot;);

<span class="nc" id="L26">        String url = &quot;jdbc:sqlite:test.db&quot;;</span>

        try {
<span class="nc" id="L29">            sqlConnection = DriverManager.getConnection(url);</span>
<span class="nc" id="L30">            System.out.println(&quot;Connection to SQLite has been established.&quot;);</span>
<span class="nc" id="L31">        } catch (SQLException e) {</span>
<span class="nc" id="L32">            System.out.println(e.getMessage());</span>
<span class="nc" id="L33">            System.exit(1);</span>
        }

        

        try {
<span class="nc" id="L39">            String q = &quot;SELECT * FROM files;&quot;;</span>
<span class="nc" id="L40">            ResultSet rs = query(q);</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L42">                System.out.println((String.valueOf(rs.getRow()))</span>
<span class="nc" id="L43">                + &quot; &quot; + rs.getString(&quot;name&quot;) </span>
<span class="nc" id="L44">                + &quot; &quot; + String.valueOf(rs.getInt(&quot;size&quot;)) </span>
<span class="nc" id="L45">                + &quot; &quot; + rs.getString(&quot;hosters&quot;));</span>
            }
<span class="nc" id="L47">        } catch (SQLException e) {</span>
<span class="nc" id="L48">            System.err.println(&quot;--- SQL ERROR ---&quot;);</span>
<span class="nc" id="L49">            e.printStackTrace();</span>
<span class="nc" id="L50">            System.err.println(&quot;---           ---&quot;);</span>
        }

        // try {
        //     ResultSet rs = query(&quot;SELECT * FROM files;&quot;);
        //     while (rs.next()) {
        //         System.out.println(rs.getString(&quot;name&quot;));
        //     }
        // } catch (SQLException e) {
        //     System.err.println(&quot;--- SQL ERROR ---&quot;);
        //     e.printStackTrace();
        //     System.err.println(&quot;---           ---&quot;);
        // }

        // try {
        //     content = Files.readString(filePath);
        // } catch (IOException e) {
        //     System.out.println(&quot;Directory not found in local folder !&quot;);
        //     try {
        //         Files.createFile(filePath);
        //         Files.writeString(filePath,&quot;{}&quot;);
        //         System.out.println(&quot;Creating directory...&quot;);
        //     } catch (IOException e2) {
        //         System.out.println(&quot;Can't create directory at path which allows directory creation. RUN.&quot;);
        //     }
        // }

        // System.out.println(&quot;Directory found.&quot;);

        // try {
        //     directory = new JSONObject(content);
        // } catch (JSONException e) {
        //     System.out.println(&quot;Invalid JSON !&quot;);
        //     e.printStackTrace();
        // }

<span class="nc" id="L86">        System.out.println(&quot;Server instance created...&quot;);</span>
<span class="nc" id="L87">    }</span>

    private ResultSet query(String sql) throws SQLException {
<span class="nc" id="L90">        Statement st = sqlConnection.createStatement();</span>
<span class="nc" id="L91">        ResultSet rs = st.executeQuery(sql);</span>
<span class="nc" id="L92">        return rs;</span>
    }

    @Override
    public String ping() throws RemoteException {
<span class="nc" id="L97">        System.out.println(&quot;Ping called !&quot;);</span>
<span class="nc" id="L98">        return &quot;Server online.&quot;;</span>
    }

    @Override
    public String addFileToDirectory(String filename, String client_adress) throws RemoteException {
        JSONArray client_array;
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (directory.has(filename)) {</span>
<span class="nc" id="L105">            client_array = (JSONArray) directory.get(filename);</span>
<span class="nc" id="L106">            client_array.put(client_adress);</span>
<span class="nc" id="L107">            directory.put(filename, client_array);</span>
<span class="nc" id="L108">            return &quot;Added client for &quot; + filename + &quot;...&quot;;</span>
        } else {
<span class="nc" id="L110">            client_array = new JSONArray();</span>
<span class="nc" id="L111">            client_array.put(client_adress);</span>
<span class="nc" id="L112">            directory.put(filename, client_array);</span>
<span class="nc" id="L113">            return &quot;Created new entry for &quot; + filename + &quot;...&quot;;</span>
        }
    }

    @Override
    public String[] getClientsForFile(String filename) throws RemoteException {
<span class="nc" id="L119">        System.out.println(&quot;Client requested : &quot; + filename);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (directory.has(filename)) {</span>
<span class="nc" id="L121">            JSONArray client_array = (JSONArray) directory.get(filename);</span>
<span class="nc" id="L122">            System.out.println(&quot;File found, returning clients...&quot;);</span>
<span class="nc" id="L123">            return (String[]) client_array.toList().toArray();</span>
        } else {
<span class="nc" id="L125">            System.out.println(&quot;File not present in directory ! Returning null...&quot;);</span>
<span class="nc" id="L126">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>